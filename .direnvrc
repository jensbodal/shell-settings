function __getnodebinpath() {
  local targetversion="$1"
  local nodedir="$N_PREFIX/n/versions/node"
  local latest=$(ls "$nodedir" | egrep "^$targetversion.*$" | sort --version-sort | tail -n 1)
  local nodebinpath="$nodedir/$latest/bin"

  if [ ! -d "$nodebinpath" ]; then
    echo "Downloading node $targetversion via n ..." >&2
    currentnodeversion=$(node --version)
    n $targetversion >&2
    n $currentnodeversion >&2
    latest=$(ls "$nodedir" | egrep "^$targetversion.*$" | sort --version-sort | tail -n 1)
    nodebinpath="$nodedir/$latest/bin"
  fi

  echo "$nodebinpath"
}

function use_node() {
  layout_node
  local version="$1"

  local NPM_BIN_PATH=""

  # place global npm dir in path if present
  if [ -d "$HOME/local/npm/bin" ]; then
    NPM_BIN_PATH="$HOME/local/npm/bin"
  fi

  if [ ! -z $NODE_VERSION_PREFIX ] && [ ! -z $NODE_VERSIONS ]; then
    local mv=`echo $version | cut -d. -f1`
    local folder="$NODE_VERSIONS/$NODE_VERSION_PREFIX$mv"

    if [ -d "$folder" ] && [ -f "$folder/bin/node" ]; then
      export PATH=$NPM_BIN_PATH:$folder/bin:$PATH
      export ENVROOT="$folder"
      return 0
    fi
  fi

  local NODE_BIN_PATH="$(__getnodebinpath $version)"

  export PATH=$NPM_BIN_PATH:$NODE_BIN_PATH:$PATH
}
